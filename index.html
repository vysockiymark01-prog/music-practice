<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú—É–∑—ã–∫–∞–ª—å–Ω–∞—è –≥—Ä–∞–º–æ—Ç–∞</title>
    <style>
        :root {
            --color-bg-primary: #f8fafc;
            --color-text-primary: #0f172a;
            --color-blue-600: #2563eb;
            --color-blue-700: #1d4ed8;
            --color-slate-100: #f1f5f9;
            --color-slate-200: #e2e8f0;
            --color-slate-300: #cbd5e1;
            --color-slate-400: #94a3b8;
            --color-slate-500: #64748b;
            --color-slate-600: #475569;
            --color-slate-700: #334155;
            --color-slate-800: #1e293b;
            --color-slate-900: #0f172a;
            --color-red-500: #ef4444;
            --color-emerald-500: #10b981;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--color-bg-primary);
            color: var(--color-text-primary);
            user-select: none;
            -webkit-user-select: none;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 12px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: white;
            border: 1px solid var(--color-slate-200);
            border-radius: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 900;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: -0.5px;
        }

        .lang-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--color-slate-100);
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 10px;
            text-transform: uppercase;
            cursor: pointer;
        }

        .tabs {
            display: flex;
            background: white;
            padding: 4px;
            border-radius: 12px;
            border: 1px solid var(--color-slate-200);
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: none;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            color: var(--color-slate-400);
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab.active {
            background: var(--color-blue-600);
            color: white;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2);
        }

        .instrument-selector {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .instrument-btn {
            padding: 6px 24px;
            border: 1px solid var(--color-slate-100);
            border-radius: 8px;
            background: white;
            color: var(--color-slate-400);
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
        }

        .instrument-btn.active {
            background: var(--color-slate-900);
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .staff-container {
            padding: 40px;
            background: white;
            border: 2px solid var(--color-slate-200);
            border-radius: 40px;
            box-shadow: 0 10px 15px rgba(0,0,0,0.05);
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }

        .staff-label {
            position: absolute;
            top: 16px;
            left: 24px;
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            color: var(--color-blue-600);
            background: #dbeafe;
            padding: 4px 12px;
            border-radius: 20px;
            z-index: 10;
        }

        .staff-scroll {
            width: 100%;
            overflow-x: auto;
        }

        .staff-scroll::-webkit-scrollbar {
            display: none;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .control-btn {
            padding: 16px;
            background: white;
            border: 1px solid var(--color-slate-200);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-btn.active {
            background: var(--color-blue-600);
            color: white;
        }

        .control-btn-text {
            font-size: 9px;
            font-weight: 900;
            text-transform: uppercase;
        }

        .piano-container {
            border: 4px solid var(--color-slate-900);
            border-radius: 32px;
            background: var(--color-slate-900);
            padding: 8px;
            box-shadow: 0 20px 25px rgba(0,0,0,0.15);
            margin-bottom: 16px;
            height: 240px;
            overflow-x: auto;
        }

        .piano-container::-webkit-scrollbar {
            display: none;
        }

        .piano-keys {
            display: flex;
            position: relative;
            padding: 4px;
            min-width: max-content;
            height: 100%;
        }

        .piano-octave {
            display: flex;
            position: relative;
            width: 420px;
        }

        .white-key {
            width: 60px;
            height: 100%;
            background: white;
            border: 1px solid var(--color-slate-200);
            border-radius: 0 0 12px 12px;
            cursor: pointer;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 16px;
            transition: all 0.1s;
            position: relative;
        }

        .white-key:active {
            background: #dbeafe;
        }

        .white-key.selected {
            background: #60a5fa;
        }

        .black-key {
            width: 36px;
            height: 60%;
            background: var(--color-slate-800);
            border: 2px solid black;
            border-radius: 0 0 8px 8px;
            position: absolute;
            top: 0;
            z-index: 10;
            cursor: pointer;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.4);
            transition: all 0.1s;
        }

        .black-key:active {
            background: #1e3a8a;
        }

        .black-key.selected {
            background: #1d4ed8;
        }

        .key-label {
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            color: var(--color-slate-400);
            pointer-events: none;
        }

        .black-key .key-label {
            color: var(--color-slate-500);
            font-size: 8px;
        }

        .fretboard-container {
            background: var(--color-slate-900);
            padding: 16px;
            border-radius: 32px;
            overflow-x: auto;
            box-shadow: 0 20px 25px rgba(0,0,0,0.15);
            margin-bottom: 16px;
        }

        .fretboard-container::-webkit-scrollbar {
            display: none;
        }

        .fretboard {
            position: relative;
            min-width: max-content;
            height: 300px;
        }

        .fret {
            position: absolute;
            top: 0;
            bottom: 40px;
            width: 1px;
            background: var(--color-slate-700);
        }

        .fret-number {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 9px;
            font-weight: 700;
            color: var(--color-slate-500);
        }

        .string {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--color-slate-500);
        }

        .fret-dot {
            position: absolute;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--color-slate-800);
            border: 1px solid var(--color-slate-600);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.1s;
            transform: translateY(-50%);
        }

        .fret-dot:active {
            transform: translateY(-50%) scale(1.1);
        }

        .fret-dot.selected {
            background: var(--color-blue-600);
            border-color: white;
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.5);
        }

        .fret-dot-label {
            font-size: 9px;
            font-weight: 900;
            color: white;
            pointer-events: none;
        }

        .scroll-control {
            background: white;
            padding: 16px;
            border-radius: 16px;
            border: 1px solid var(--color-slate-200);
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .scroll-slider {
            flex: 1;
            height: 8px;
            background: var(--color-slate-100);
            border-radius: 8px;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        .scroll-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--color-blue-600);
            border-radius: 50%;
            cursor: pointer;
        }

        .rhythm-box {
            background: white;
            padding: 32px;
            border-radius: 32px;
            border: 1px solid var(--color-slate-200);
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .rhythm-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .time-sig-selector {
            display: flex;
            gap: 8px;
        }

        .time-sig-btn {
            padding: 8px 16px;
            background: var(--color-slate-100);
            border: none;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 900;
            color: var(--color-slate-400);
            cursor: pointer;
            transition: all 0.2s;
        }

        .time-sig-btn.active {
            background: var(--color-blue-600);
            color: white;
        }

        .rhythm-display {
            padding: 32px;
            background: var(--color-slate-900);
            border-radius: 24px;
            min-height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 32px;
            flex-wrap: wrap;
            margin-bottom: 32px;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }

        .rhythm-note {
            font-size: 60px;
            color: white;
            line-height: 1;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .rhythm-hint {
            display: flex;
            align-items: center;
            gap: 16px;
            color: var(--color-slate-500);
            text-align: center;
        }

        .rhythm-hint-text {
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-style: italic;
        }

        .rhythm-user-box {
            padding: 24px;
            background: var(--color-slate-50);
            border: 2px dashed var(--color-slate-200);
            border-radius: 24px;
            min-height: 160px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 16px;
            margin-bottom: 32px;
        }

        .rhythm-user-placeholder {
            color: var(--color-slate-300);
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .rhythm-user-note {
            width: 64px;
            height: 96px;
            background: white;
            border: 1px solid var(--color-slate-200);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .duration-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }

        .duration-btn {
            height: 112px;
            background: white;
            border: 1px solid var(--color-slate-200);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .duration-btn:hover {
            border-color: var(--color-blue-600);
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.1);
        }

        .duration-btn:active {
            transform: scale(0.95);
        }

        .duration-symbol {
            font-size: 40px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .duration-btn:hover .duration-symbol {
            color: var(--color-blue-600);
            transform: scale(1.1);
        }

        .duration-label {
            font-size: 8px;
            font-weight: 900;
            color: var(--color-slate-400);
            text-transform: uppercase;
            text-align: center;
        }

        .rhythm-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .rhythm-actions-full {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        .action-btn {
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .action-btn.primary {
            background: var(--color-blue-600);
            color: white;
        }

        .action-btn.primary:hover {
            background: var(--color-blue-700);
        }

        .action-btn.secondary {
            background: white;
            color: var(--color-slate-600);
            border: 1px solid var(--color-slate-200);
        }

        .action-btn.secondary:hover {
            background: var(--color-slate-50);
        }

        .action-btn.danger {
            background: var(--color-red-500);
            color: white;
        }

        .action-btn.success {
            background: var(--color-emerald-500);
            color: white;
        }

        .action-btn.dark {
            background: var(--color-slate-800);
            color: white;
        }

        .feedback-modal {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.2);
            backdrop-filter: blur(4px);
            z-index: 9999;
        }

        .feedback-content {
            background: white;
            padding: 48px;
            border-radius: 40px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            transform: scale(1.1);
        }

        .feedback-text {
            font-size: 30px;
            font-weight: 900;
            text-align: center;
        }

        .feedback-text.correct {
            color: var(--color-emerald-500);
        }

        .feedback-text.wrong {
            color: var(--color-red-500);
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }

            .staff-container {
                padding: 16px;
                border-radius: 24px;
            }

            .control-grid {
                gap: 6px;
            }

            .control-btn {
                padding: 12px;
            }

            .piano-container {
                height: 192px;
                border-radius: 24px;
            }

            .piano-octave {
                width: 336px;
            }

            .white-key {
                width: 48px;
            }

            .rhythm-box {
                padding: 16px;
            }

            .rhythm-display {
                padding: 16px;
                min-height: 100px;
            }

            .rhythm-note {
                font-size: 48px;
            }

            .duration-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }

            .duration-btn {
                height: 80px;
            }

            .duration-symbol {
                font-size: 32px;
            }

            .rhythm-actions {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .rhythm-actions-full {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .feedback-content {
                padding: 32px;
            }

            .feedback-text {
                font-size: 24px;
            }
        }

        svg {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18V5l12-2v13"></path>
                    <circle cx="6" cy="18" r="3"></circle>
                    <circle cx="18" cy="16" r="3"></circle>
                </svg>
                <span id="appTitle">–ú—É–∑—ã–∫–∞–ª—å–Ω–∞—è –≥—Ä–∞–º–æ—Ç–∞</span>
            </div>
            <button class="lang-btn" id="langBtn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="m5 8 6 6"></path>
                    <path d="m4 14 6-6 2-3"></path>
                    <path d="M2 5h12"></path>
                    <path d="M7 2h1"></path>
                    <path d="m22 22-5-10-5 10"></path>
                    <path d="M14 18h6"></path>
                </svg>
                <span id="langText">EN</span>
            </button>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="theory" id="theoryTab">–¢–µ–æ—Ä–∏—è</button>
            <button class="tab" data-tab="rhythm" id="rhythmTab">–†–∏—Ç–º</button>
            <button class="tab" data-tab="composer" id="composerTab">–ö–æ–º–ø–æ–∑–∏—Ç–æ—Ä</button>
        </div>

        <div id="theoryContent">
            <div class="instrument-selector">
                <button class="instrument-btn active" data-instr="piano" id="pianoBtn">–ü–∏–∞–Ω–∏–Ω–æ</button>
                <button class="instrument-btn" data-instr="guitar" id="guitarBtn">–ì–∏—Ç–∞—Ä–∞</button>
                <button class="instrument-btn" data-instr="balalaika" id="balalaika">–ë–∞–ª–∞–ª–∞–π–∫–∞</button>
                <button class="instrument-btn" data-instr="domra" id="domraBtn">–î–æ–º—Ä–∞</button>
            </div>

            <div class="staff-container">
                <div class="staff-label" id="staffLabel">1 –û–ö–¢. ‚Äî –î–û</div>
                <div class="staff-scroll" id="staffScrollContainer">
                    <svg id="staffSvg" viewBox="0 0 800 240" style="height: 288px; width: 100%; min-width: 800px;"></svg>
                </div>
            </div>

            <div class="control-grid">
                <button class="control-btn" id="testModeBtn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 10v6M2 10l10-5 10 5-10 5z"></path>
                        <path d="M6 12v5c3 3 9 3 12 0v-5"></path>
                    </svg>
                    <span class="control-btn-text" id="testModeText">–¢–µ—Å—Ç</span>
                </button>
                <button class="control-btn" id="hintBtn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    <span class="control-btn-text">–ü–æ–¥—Å–∫–∞–∑–∫–∞</span>
                </button>
                <button class="control-btn active" id="showLabelsBtn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="4 7 4 4 20 4 20 7"></polyline>
                        <line x1="9" y1="20" x2="15" y2="20"></line>
                        <line x1="12" y1="4" x2="12" y2="20"></line>
                    </svg>
                    <span class="control-btn-text">–ù–æ—Ç—ã</span>
                </button>
            </div>

            <div id="pianoContainer" class="piano-container">
                <div class="piano-keys" id="pianoKeys"></div>
            </div>

            <div id="fretboardContainer" class="fretboard-container hidden">
                <div class="fretboard" id="fretboard"></div>
            </div>

            <div class="scroll-control">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="5 9 2 12 5 15"></polyline>
                    <polyline points="9 5 12 2 15 5"></polyline>
                    <polyline points="15 19 12 22 9 19"></polyline>
                    <polyline points="19 9 22 12 19 15"></polyline>
                    <line x1="2" y1="12" x2="22" y2="12"></line>
                    <line x1="12" y1="2" x2="12" y2="22"></line>
                </svg>
                <input type="range" class="scroll-slider" min="0" max="100" value="40" id="pianoScroll">
            </div>
        </div>

        <div id="rhythmContent" class="hidden">
            <div class="rhythm-box">
                <div class="rhythm-header">
                    <div class="time-sig-selector">
                        <button class="time-sig-btn" data-sig="2/4">2/4</button>
                        <button class="time-sig-btn" data-sig="3/4">3/4</button>
                        <button class="time-sig-btn active" data-sig="4/4">4/4</button>
                    </div>
                    <button class="control-btn" id="showRhythmTargetBtn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                        <span class="control-btn-text">–ü–æ–∫–∞–∑–∞—Ç—å —Ä–∏—Ç–º</span>
                    </button>
                </div>

                <div class="rhythm-display" id="rhythmDisplay">
                    <div class="rhythm-hint">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: pulse 2s ease-in-out infinite;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                        <span class="rhythm-hint-text">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —Ä–∏—Ç–º, –≤—ã–±–∏—Ä–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –Ω–∏–∂–µ.</span>
                    </div>
                </div>

                <div class="rhythm-user-box" id="userRhythmBox">
                    <span class="rhythm-user-placeholder">–¢–≤–æ–π –æ—Ç–≤–µ—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</span>
                </div>

                <div class="duration-grid" id="durationGrid"></div>

                <div class="rhythm-actions-full" id="rhythmActions"></div>
            </div>
        </div>

        <div id="composerContent" class="hidden">
            <div class="staff-container">
                <div class="staff-label">–ö–æ–º–ø–æ–∑–∏—Ç–æ—Ä</div>
                <div class="staff-scroll" id="composerStaffScrollContainer">
                    <svg id="composerStaffSvg" viewBox="0 0 800 240" style="height: 288px; width: 100%; min-width: 800px;"></svg>
                </div>
            </div>

            <div class="scroll-control" id="composerScrollControl" style="display: none;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="5 9 2 12 5 15"></polyline>
                    <polyline points="19 9 22 12 19 15"></polyline>
                    <line x1="2" y1="12" x2="22" y2="12"></line>
                </svg>
                <input type="range" class="scroll-slider" min="0" max="100" value="0" id="composerScroll">
            </div>

            <div class="rhythm-box">
                <div class="duration-grid" id="composerDurationGrid"></div>
                <div class="duration-grid" style="padding-top: 16px; border-top: 1px solid var(--color-slate-200);" id="composerRestGrid"></div>
            </div>

            <div class="rhythm-actions-full" id="composerActions"></div>

            <div class="piano-container">
                <div class="piano-keys" id="composerPianoKeys"></div>
            </div>

            <div class="scroll-control">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18V5l12-2v13"></path>
                    <circle cx="6" cy="18" r="3"></circle>
                    <circle cx="18" cy="16" r="3"></circle>
                </svg>
                <input type="range" class="scroll-slider" min="0" max="100" value="40" id="composerPianoScroll">
            </div>
        </div>
    </div>

    <div id="feedbackModal" class="feedback-modal hidden">
        <div class="feedback-content">
            <div class="feedback-text" id="feedbackText">–í–µ—Ä–Ω–æ! üéâ</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.1/lame.min.js"></script>

    <script>
        const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        
        const TRANSLATIONS = {
            ru: {
                appTitle: '–ú—É–∑—ã–∫–∞–ª—å–Ω–∞—è –≥—Ä–∞–º–æ—Ç–∞',
                piano: '–ü–∏–∞–Ω–∏–Ω–æ',
                guitar: '–ì–∏—Ç–∞—Ä–∞',
                balalaika: '–ë–∞–ª–∞–ª–∞–π–∫–∞',
                domra: '–î–æ–º—Ä–∞',
                testMode: '–¢–µ—Å—Ç',
                exit: '–í—ã—Ö–æ–¥',
                theory: '–¢–µ–æ—Ä–∏—è',
                rhythm: '–†–∏—Ç–º',
                composer: '–ö–æ–º–ø–æ–∑–∏—Ç–æ—Ä',
                correct: '–í–µ—Ä–Ω–æ! üéâ',
                wrong: '–ü–æ–ø—Ä–æ–±—É–π –µ—â–µ üéπ',
                listenRhythm: '–°–ª—É—à–∞—Ç—å',
                newRhythm: '–ù–æ–≤—ã–π —Ä–∏—Ç–º',
                check: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å',
                deleteAll: '–û—á–∏—Å—Ç–∏—Ç—å',
                deleteLast: '–£–¥–∞–ª–∏—Ç—å',
                stop: '–°—Ç–æ–ø',
                download: '–°–∫–∞—á–∞—Ç—å MP3',
                rendering: '–°–æ–∑–¥–∞–Ω–∏–µ...',
                durations: { whole: '–¶–µ–ª–∞—è', half: '–ü–æ–ª–æ–≤.', quarter: '–ß–µ—Ç–≤.', eighth: '–í–æ—Å—å–º.' },
                rests: { whole: '–ü–∞—É–∑–∞ —Ü.', half: '–ü–∞—É–∑–∞ –ø.', quarter: '–ü–∞—É–∑–∞ —á.', eighth: '–ü–∞—É–∑–∞ –≤.' },
                octaves: { 2: '–ë–û–õ–¨–®–ê–Ø', 3: '–ú–ê–õ–ê–Ø', 4: '1 –û–ö–¢.', 5: '2 –û–ö–¢.', 6: '3 –û–ö–¢.' },
                notes: { 'C': '–î–û', 'C#': '–î–û#', 'D': '–†–ï', 'D#': '–†–ï#', 'E': '–ú–ò', 'F': '–§–ê', 'F#': '–§–ê#', 'G': '–°–û–õ–¨', 'G#': '–°–û–õ–¨#', 'A': '–õ–Ø', 'A#': '–õ–Ø#', 'B': '–°–ò' }
            },
            en: {
                appTitle: 'Music Theory',
                piano: 'Piano',
                guitar: 'Guitar',
                balalaika: 'Balalaika',
                domra: 'Domra',
                testMode: 'Test',
                exit: 'Exit',
                theory: 'Theory',
                rhythm: 'Rhythm',
                composer: 'Composer',
                correct: 'Correct! üéâ',
                wrong: 'Try again üéπ',
                listenRhythm: 'Listen',
                newRhythm: 'New',
                check: 'Check',
                deleteAll: 'Clear',
                deleteLast: 'Undo',
                stop: 'Stop',
                download: 'Download MP3',
                rendering: 'Rendering...',
                durations: { whole: 'Whole', half: 'Half', quarter: 'Quarter', eighth: 'Eighth' },
                rests: { whole: 'W. Rest', half: 'H. Rest', quarter: 'Q. Rest', eighth: 'E. Rest' },
                octaves: { 2: 'GREAT', 3: 'SMALL', 4: '1st OCT.', 5: '2nd OCT.', 6: '3rd OCT.' },
                notes: { 'C': 'C', 'C#': 'C#', 'D': 'D', 'D#': 'D#', 'E': 'E', 'F': 'F', 'F#': 'F#', 'G': 'G', 'G#': 'G#', 'A': 'A', 'A#': 'A#', 'B': 'B' }
            }
        };

        const DURATIONS = [
            { id: 'whole', label: 'ùÖù', restLabel: 'ùÑª', val: 4 },
            { id: 'half', label: 'ùÖóùÖ•', restLabel: 'ùÑº', val: 2 },
            { id: 'quarter', label: 'ùÖòùÖ•', restLabel: 'ùÑΩ', val: 1 },
            { id: 'eighth', label: 'ùÖòùÖ•ùÖÆ', restLabel: 'ùÑæ', val: 0.5 }
        ];

        let lang = 'ru';
        let activeTab = 'theory';
        let instrMode = 'piano';
        let selectedNote = { note: 'C', octave: 4 };
        let showHint = false;
        let showKeyLabels = true;
        let isTestMode = false;
        let testNote = null;
        let audioCtx = null;
        let activeNodes = [];
        let rhythmSig = '4/4';
        let targetRhythm = [];
        let userRhythm = [];
        let isListening = false;
        let showRhythmTarget = false;
        let composerNotes = [];
        let compDuration = 'quarter';
        let isRendering = false;
        let stopPlayback = false;

        function getFrequency(note, octave) {
            if (note === 'PAUSE' || !note) return 0;
            const semitoneMap = { 'C': 0, 'C#': 1, 'D': 2, 'D#': 3, 'E': 4, 'F': 5, 'F#': 6, 'G': 7, 'G#': 8, 'A': 9, 'A#': 10, 'B': 11 };
            const n = semitoneMap[note] + (octave + 1) * 12;
            return 440 * Math.pow(2, (n - 69) / 12);
        }

        function playFrequency(note, octave, duration = 0.8) {
            if (note === 'PAUSE' || !note) return;
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const freq = getFrequency(note, octave);
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.4, audioCtx.currentTime + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
            activeNodes.push({ osc, gain });
            setTimeout(() => {
                activeNodes = activeNodes.filter(n => n.osc !== osc);
            }, duration * 1000);
        }

        function stopAllSounds() {
            stopPlayback = true;
            activeNodes.forEach(node => {
                try { node.osc.stop(); node.osc.disconnect(); node.gain.disconnect(); } catch(e) {}
            });
            activeNodes = [];
            isListening = false;
        }

        async function playSequence(sequence) {
            if (sequence.length === 0) return;
            if (isListening) { stopAllSounds(); updateUI(); return; }
            isListening = true;
            stopPlayback = false;
            updateUI();
            for (const item of sequence) {
                if (stopPlayback) break;
                const isPause = item.isPause || item.note === 'PAUSE';
                if (!isPause) playFrequency(item.note || 'A', item.octave || 4, (item.duration || item.val) * 0.4);
                await new Promise(r => setTimeout(r, (item.duration || item.val) * 500));
            }
            if (!stopPlayback) isListening = false;
            updateUI();
        }

        function drawStaff(svgId, note, octave, isComposer = false, composerNotesList = []) {
            const svg = document.getElementById(svgId);
            const isFolkInstrument = ['guitar', 'domra', 'balalaika'].includes(instrMode);
            const staffWidth = isComposer ? Math.max(800, 120 + composerNotesList.length * 70) : 800;
            svg.setAttribute('viewBox', `0 0 ${staffWidth} 240`);
            svg.style.minWidth = staffWidth + 'px';
            
            let html = '';
            
            html += '<g transform="translate(0, 40)">';
            for (let i = 0; i < 5; i++) {
                html += `<line x1="20" y1="${i * 10}" x2="${staffWidth - 20}" y2="${i * 10}" stroke="#cbd5e1" stroke-width="1.5"/>`;
            }
            html += '<text x="30" y="38" font-size="58" fill="#020617" font-family="serif">ùÑû</text>';
            html += '</g>';

            if (!isFolkInstrument || isComposer) {
                html += '<g transform="translate(0, 140)">';
                for (let i = 0; i < 5; i++) {
                    html += `<line x1="20" y1="${i * 10}" x2="${staffWidth - 20}" y2="${i * 10}" stroke="#cbd5e1" stroke-width="1.5"/>`;
                }
                html += '<text x="30" y="38" font-size="52" fill="#020617" font-family="serif">ùÑ¢</text>';
                html += '</g>';
                html += '<path d="M 25 40 Q 10 95 25 180" fill="none" stroke="#cbd5e1" stroke-width="2"/>';
            }

            function renderNote(noteObj, xOffset) {
                const { note: noteName, octave: noteOct, type } = noteObj;
                const color = '#020617';
                const activeKey = isComposer ? (noteOct < 4 ? 'bass' : 'treble') : (isFolkInstrument ? 'treble' : (noteOct < 4 ? 'bass' : 'treble'));
                const isBass = activeKey === 'bass';
                const staffY = isBass ? 140 : 40;

                if (noteObj.isPause) {
                    const pauseY = staffY + 20;
                    if (type === 'whole') return `<rect x="${xOffset - 8}" y="${pauseY - 10}" width="16" height="6" fill="${color}"/>`;
                    if (type === 'half') return `<rect x="${xOffset - 8}" y="${pauseY - 6}" width="16" height="6" fill="${color}"/>`;
                    if (type === 'quarter') return `<text x="${xOffset - 10}" y="${pauseY + 15}" font-size="45" fill="${color}" font-family="serif">ùÑΩ</text>`;
                    if (type === 'eighth') return `<text x="${xOffset - 10}" y="${pauseY + 15}" font-size="45" fill="${color}" font-family="serif">ùÑæ</text>`;
                    return '';
                }

                const cleanN = noteName.replace('#', '');
                let relativeY = 30;
                let ledgerLines = [];

                if (isBass) {
                    const bassMap = { 2: { 'C': 60, 'D': 55, 'E': 50, 'F': 45, 'G': 40, 'A': 35, 'B': 30 }, 3: { 'C': 25, 'D': 20, 'E': 15, 'F': 10, 'G': 5, 'A': 0, 'B': -5 }, 4: { 'C': -10 } };
                    relativeY = (bassMap[noteOct] && bassMap[noteOct][cleanN]) ? bassMap[noteOct][cleanN] : 30;
                    if (relativeY >= 50) ledgerLines.push(50);
                    if (relativeY >= 60) ledgerLines.push(60);
                    if (relativeY <= -10) ledgerLines.push(-10);
                } else {
                    const trebleMap = {
                        2: { 'C': 120, 'D': 115, 'E': 110, 'F': 105, 'G': 100, 'A': 95, 'B': 90 },
                        3: { 'C': 85, 'D': 80, 'E': 75, 'F': 70, 'G': 65, 'A': 60, 'B': 55 },
                        4: { 'C': 50, 'D': 45, 'E': 40, 'F': 35, 'G': 30, 'A': 25, 'B': 20 },
                        5: { 'C': 15, 'D': 10, 'E': 5, 'F': 0, 'G': -5, 'A': -10, 'B': -15 },
                        6: { 'C': -20, 'D': -25, 'E': -30, 'F': -35, 'G': -40, 'A': -45, 'B': -50 }
                    };
                    relativeY = (trebleMap[noteOct] && trebleMap[noteOct][cleanN]) ? trebleMap[noteOct][cleanN] : 30;
                    [50, 60, 70, 80, 90, 100, 110, 120, -10, -20, -30, -40, -50].forEach(l => { if ((l > 0 && relativeY >= l) || (l < 0 && relativeY <= l)) ledgerLines.push(l); });
                }

                const absY = staffY + relativeY;
                const stemUp = isBass ? (relativeY > 15) : (relativeY > 20);
                const isWhole = type === 'whole';
                const isHalf = type === 'half';
                const isEighth = type === 'eighth';

                let noteHtml = '<g>';
                ledgerLines.forEach(l => {
                    noteHtml += `<line x1="${xOffset - 18}" y1="${staffY + l}" x2="${xOffset + 18}" y2="${staffY + l}" stroke="${color}" stroke-width="1.5"/>`;
                });
                if (noteName.includes('#')) {
                    noteHtml += `<text x="${xOffset - 30}" y="${absY + 7}" font-size="28" font-weight="bold" fill="${color}">‚ôØ</text>`;
                }
                noteHtml += `<g transform="translate(${xOffset}, ${absY})">`;
                noteHtml += `<ellipse rx="9" ry="6.5" fill="${isWhole || isHalf ? 'none' : color}" stroke="${color}" stroke-width="${isWhole || isHalf ? '2' : '0'}" transform="rotate(-20)"/>`;
                if (!isWhole) {
                    noteHtml += `<line x1="${stemUp ? 8.5 : -8.5}" y1="0" x2="${stemUp ? 8.5 : -8.5}" y2="${stemUp ? -35 : 35}" stroke="${color}" stroke-width="2"/>`;
                    if (isEighth) {
                        noteHtml += `<path d="${stemUp ? 'M 8.5 -35 Q 20 -25 20 -10' : 'M -8.5 35 Q 5 25 5 10'}" fill="none" stroke="${color}" stroke-width="2"/>`;
                    }
                }
                noteHtml += '</g></g>';
                return noteHtml;
            }

            if (isComposer) {
                composerNotesList.forEach((noteObj, idx) => {
                    html += renderNote(noteObj, 120 + idx * 70);
                });
            } else {
                html += renderNote({ note, octave, type: 'quarter', isPause: false }, 400);
            }

            svg.innerHTML = html;
        }

        function createPiano(containerId) {
            const container = document.getElementById(containerId);
            const whiteNotes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
            const blackPos = { 'C#': 1, 'D#': 2, 'F#': 4, 'G#': 5, 'A#': 6 };
            const octaves = [2, 3, 4, 5, 6];
            const whiteWidth = window.innerWidth < 768 ? 48 : 60;
            
            let html = '';
            octaves.forEach(oct => {
                html += `<div style="display: flex; position: relative; width: ${whiteWidth * 7}px;">`;
                whiteNotes.forEach(n => {
                    const isSelected = selectedNote.note === n && selectedNote.octave === oct;
                    html += `<button class="white-key ${isSelected ? 'selected' : ''}" data-note="${n}" data-octave="${oct}" style="width: ${whiteWidth}px;">`;
                    if (showKeyLabels) html += `<span class="key-label">${TRANSLATIONS[lang].notes[n]}</span>`;
                    html += '</button>';
                });
                Object.entries(blackPos).forEach(([n, pos]) => {
                    const isSelected = selectedNote.note === n && selectedNote.octave === oct;
                    html += `<button class="black-key ${isSelected ? 'selected' : ''}" data-note="${n}" data-octave="${oct}" style="left: ${(pos - 1) * whiteWidth + (whiteWidth * 0.7)}px; width: ${whiteWidth * 0.6}px;">`;
                    if (showKeyLabels) html += `<span class="key-label">${TRANSLATIONS[lang].notes[n]}</span>`;
                    html += '</button>';
                });
                html += '</div>';
            });
            container.innerHTML = html;

            container.querySelectorAll('button').forEach(btn => {
                const handleClick = (e) => {
                    e.preventDefault();
                    const note = btn.dataset.note;
                    const octave = parseInt(btn.dataset.octave);
                    handleNoteClick(note, octave);
                };
                btn.addEventListener('mousedown', handleClick);
                btn.addEventListener('touchstart', handleClick);
            });
        }

        function createFretboard() {
            const container = document.getElementById('fretboard');
            const strings = instrMode === 'guitar' ? 
                [{ note: 'E', octave: 5 }, { note: 'B', octave: 4 }, { note: 'G', octave: 4 }, { note: 'D', octave: 4 }, { note: 'A', octave: 3 }, { note: 'E', octave: 3 }] :
                instrMode === 'balalaika' ?
                [{ note: 'A', octave: 4 }, { note: 'E', octave: 4 }, { note: 'E', octave: 4 }] :
                [{ note: 'D', octave: 5 }, { note: 'A', octave: 4 }, { note: 'E', octave: 4 }];
            const fretsCount = instrMode === 'balalaika' ? 24 : (instrMode === 'domra' ? 14 : 19);
            const fretWidth = 70;
            
            container.style.width = (fretsCount + 1) * fretWidth + 100 + 'px';
            container.style.height = strings.length * 40 + 60 + 'px';
            
            let html = '';
            for (let i = 0; i <= fretsCount; i++) {
                html += `<div class="fret" style="left: ${i * fretWidth + 60}px;"><span class="fret-number">${i}</span></div>`;
            }

            function getNoteAtFret(openNote, openOctave, fret) {
                const startIndex = NOTES.indexOf(openNote);
                const noteIndex = (startIndex + fret) % 12;
                const octaveShift = Math.floor((startIndex + fret) / 12);
                return { note: NOTES[noteIndex], octave: openOctave + octaveShift };
            }

            strings.forEach((string, sIdx) => {
                html += `<div class="string" style="top: ${sIdx * 40 + 30}px;"></div>`;
                for (let fIdx = 0; fIdx <= fretsCount; fIdx++) {
                    const { note, octave } = getNoteAtFret(string.note, string.octave, fIdx);
                    const isActive = selectedNote.note === note && selectedNote.octave === octave;
                    html += `<button class="fret-dot ${isActive ? 'selected' : ''}" data-note="${note}" data-octave="${octave}" style="left: ${fIdx * fretWidth + 25}px; top: ${sIdx * 40 + 30}px;">`;
                    if (showKeyLabels) html += `<span class="fret-dot-label">${TRANSLATIONS[lang].notes[note]}</span>`;
                    html += '</button>';
                }
            });

            container.innerHTML = html;

            container.querySelectorAll('.fret-dot').forEach(btn => {
                const handleClick = (e) => {
                    e.preventDefault();
                    const note = btn.dataset.note;
                    const octave = parseInt(btn.dataset.octave);
                    handleNoteClick(note, octave);
                };
                btn.addEventListener('mousedown', handleClick);
                btn.addEventListener('touchstart', handleClick);
            });
        }

        function handleNoteClick(note, octave) {
            playFrequency(note, octave);
            selectedNote = { note, octave };

            if (activeTab === 'composer') {
                const d = DURATIONS.find(dur => dur.id === compDuration);
                composerNotes.push({ note, octave, duration: d.val, type: d.id, label: d.label, isPause: false });
                updateComposerStaff();
            }

            if (activeTab === 'theory' && isTestMode && testNote) {
                if (note === testNote.note && octave === testNote.octave) {
                    showFeedback(TRANSLATIONS[lang].correct, true);
                    setTimeout(() => generateNewTestNote(), 800);
                } else {
                    showFeedback(TRANSLATIONS[lang].wrong, false);
                }
            }

            updateUI();
        }

        function showFeedback(text, isCorrect) {
            const modal = document.getElementById('feedbackModal');
            const feedbackText = document.getElementById('feedbackText');
            feedbackText.textContent = text;
            feedbackText.className = 'feedback-text ' + (isCorrect ? 'correct' : 'wrong');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('hidden'), isCorrect ? 800 : 1000);
        }

        function generateNewTestNote() {
            const availableNotes = NOTES.filter(n => !n.includes('#'));
            testNote = { 
                note: availableNotes[Math.floor(Math.random() * availableNotes.length)], 
                octave: [3, 4, 5][Math.floor(Math.random() * 3)] 
            };
            showHint = false;
            updateUI();
        }

        function generateNewRhythm() {
            const beats = parseInt(rhythmSig.split('/')[0]);
            let current = 0;
            let newTarget = [];
            while (current < beats) {
                const possible = DURATIONS.filter(d => d.val <= (beats - current));
                const chosen = possible[Math.floor(Math.random() * possible.length)];
                newTarget.push(chosen);
                current += chosen.val;
            }
            targetRhythm = newTarget;
            userRhythm = [];
            showRhythmTarget = false;
            updateRhythmUI();
        }

        function checkRhythm() {
            const isCorrect = JSON.stringify(targetRhythm.map(d => d.id)) === JSON.stringify(userRhythm.map(d => d.id));
            showFeedback(isCorrect ? TRANSLATIONS[lang].correct : TRANSLATIONS[lang].wrong, isCorrect);
        }

        function updateRhythmUI() {
            const display = document.getElementById('rhythmDisplay');
            if (showRhythmTarget && targetRhythm.length > 0) {
                display.innerHTML = targetRhythm.map(item => `<div class="rhythm-note">${item.label}</div>`).join('');
            } else {
                display.innerHTML = `<div class="rhythm-hint">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: pulse 2s ease-in-out infinite;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    <span class="rhythm-hint-text">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —Ä–∏—Ç–º, –≤—ã–±–∏—Ä–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –Ω–∏–∂–µ.</span>
                </div>`;
            }

            const userBox = document.getElementById('userRhythmBox');
            if (userRhythm.length === 0) {
                userBox.innerHTML = '<span class="rhythm-user-placeholder">–¢–≤–æ–π –æ—Ç–≤–µ—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</span>';
            } else {
                userBox.innerHTML = userRhythm.map(item => `<div class="rhythm-user-note">${item.label}</div>`).join('');
            }

            document.getElementById('showRhythmTargetBtn').classList.toggle('active', showRhythmTarget);
        }

        function updateComposerStaff() {
            drawStaff('composerStaffSvg', selectedNote.note, selectedNote.octave, true, composerNotes);
            const scrollControl = document.getElementById('composerScrollControl');
            if (composerNotes.length > 4) {
                scrollControl.style.display = 'flex';
            } else {
                scrollControl.style.display = 'none';
            }
        }

        function updateUI() {
            const t = TRANSLATIONS[lang];
            document.getElementById('appTitle').textContent = t.appTitle;
            document.getElementById('langText').textContent = lang === 'ru' ? 'EN' : 'RU';
            document.getElementById('theoryTab').textContent = t.theory;
            document.getElementById('rhythmTab').textContent = t.rhythm;
            document.getElementById('composerTab').textContent = t.composer;
            document.getElementById('pianoBtn').textContent = t.piano;
            document.getElementById('guitarBtn').textContent = t.guitar;
            document.getElementById('balalaika').textContent = t.balalaika;
            document.getElementById('domraBtn').textContent = t.domra;
            document.getElementById('testModeText').textContent = isTestMode ? t.exit : t.testMode;

            const displayNote = isTestMode && testNote ? testNote : selectedNote;
            const octaveName = t.octaves[displayNote.octave] || '';
            const noteName = showHint ? ` ‚Äî ${t.notes[displayNote.note]}` : '';
            document.getElementById('staffLabel').textContent = octaveName + noteName;

            drawStaff('staffSvg', displayNote.note, displayNote.octave);

            document.getElementById('testModeBtn').classList.toggle('active', isTestMode);
            document.getElementById('hintBtn').classList.toggle('active', showHint);
            document.getElementById('showLabelsBtn').classList.toggle('active', showKeyLabels);

            if (instrMode === 'piano') {
                document.getElementById('pianoContainer').classList.remove('hidden');
                document.getElementById('fretboardContainer').classList.add('hidden');
                createPiano('pianoKeys');
            } else {
                document.getElementById('pianoContainer').classList.add('hidden');
                document.getElementById('fretboardContainer').classList.remove('hidden');
                createFretboard();
            }
        }

        async function createMp3Blob(notes, sampleRate = 44100) {
            if (typeof lamejs === 'undefined') {
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.1/lame.min.js';
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }
            const mp3encoder = new lamejs.Mp3Encoder(1, sampleRate, 128);
            const mp3Data = [];
            const tempo = 120;
            const secondsPerBeat = 60 / tempo;
            for (const noteObj of notes) {
                const durationSec = (noteObj.duration || noteObj.val) * secondsPerBeat;
                const numSamples = Math.floor(durationSec * sampleRate);
                const samples = new Int16Array(numSamples);
                if (!noteObj.isPause && noteObj.note !== 'PAUSE') {
                    const freq = getFrequency(noteObj.note, noteObj.octave);
                    for (let i = 0; i < numSamples; i++) {
                        const t = i / sampleRate;
                        const envelope = Math.exp(-t * 3);
                        const sample = Math.sin(2 * Math.PI * freq * t) * 0.5 * envelope;
                        samples[i] = sample * 32767;
                    }
                } else { samples.fill(0); }
                const mp3buf = mp3encoder.encodeBuffer(samples);
                if (mp3buf.length > 0) mp3Data.push(new Int8Array(mp3buf));
            }
            const endBuf = mp3encoder.flush();
            if (endBuf.length > 0) mp3Data.push(new Int8Array(endBuf));
            return new Blob(mp3Data, { type: 'audio/mp3' });
        }

        async function handleDownloadMp3() {
            if (composerNotes.length === 0 || isRendering) return;
            isRendering = true;
            updateComposerActions();
            try {
                const blob = await createMp3Blob(composerNotes);
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'composition.mp3';
                a.click();
                URL.revokeObjectURL(url);
            } catch (e) {
                console.error(e);
            } finally {
                isRendering = false;
                updateComposerActions();
            }
        }

        function updateComposerActions() {
            const t = TRANSLATIONS[lang];
            const actions = document.getElementById('composerActions');
            const listenText = isListening ? t.stop : t.listenRhythm;
            const downloadText = isRendering ? t.rendering : t.download;
            
            actions.innerHTML = `
                <button class="action-btn ${isListening ? 'danger' : 'primary'}" id="composerListenBtn">
                    ${isListening ? 
                        '<svg width="16" height="16" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>' :
                        '<svg width="16" height="16" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>'
                    }
                    ${listenText}
                </button>
                <button class="action-btn dark" id="composerUndoBtn"onclick="composerNotes.pop(); updateComposerStaff(); createPiano('composerPianoKeys');">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path d="M3 7v6h6"></path>
                        <path d="M21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13"></path>
                    </svg>
                    ${t.deleteLast}
                </button>
                <button class="action-btn danger" onclick="stopAllSounds(); composerNotes = []; updateComposerStaff(); createPiano('composerPianoKeys');">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                    ${t.deleteAll}
                </button>
                <button class="action-btn success" id="composerDownloadBtn" ${isRendering || composerNotes.length === 0 ? 'disabled' : ''}>
                    ${isRendering ?
                        '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" style="animation: spin 1s linear infinite;"><path d="M21 12a9 9 0 11-6.219-8.56"></path></svg>' :
                        '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>'
                    }
                    ${downloadText}
                </button>
            `;

            document.getElementById('composerListenBtn').addEventListener('click', () => playSequence(composerNotes));
            document.getElementById('composerDownloadBtn').addEventListener('click', handleDownloadMp3);
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('langBtn').addEventListener('click', () => {
                lang = lang === 'ru' ? 'en' : 'ru';
                updateUI();
                if (activeTab === 'rhythm') updateRhythmUI();
                if (activeTab === 'composer') { updateComposerStaff(); updateComposerActions(); }
            });

            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    stopAllSounds();
                    const tabName = tab.dataset.tab;
                    activeTab = tabName;
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById('theoryContent').classList.toggle('hidden', tabName !== 'theory');
                    document.getElementById('rhythmContent').classList.toggle('hidden', tabName !== 'rhythm');
                    document.getElementById('composerContent').classList.toggle('hidden', tabName !== 'composer');
                    
                    if (tabName === 'rhythm' && targetRhythm.length === 0) {
                        generateNewRhythm();
                    }
                    if (tabName === 'composer') {
                        updateComposerStaff();
                        createPiano('composerPianoKeys');
                        updateComposerActions();
                        
                        const durationGrid = document.getElementById('composerDurationGrid');
                        const t = TRANSLATIONS[lang];
                        durationGrid.innerHTML = DURATIONS.map(d => `
                            <button class="duration-btn ${compDuration === d.id ? 'active' : ''}" data-duration="${d.id}">
                                <div class="duration-symbol">${d.label}</div>
                                <div class="duration-label">${t.durations[d.id]}</div>
                            </button>
                        `).join('');

                        durationGrid.querySelectorAll('.duration-btn').forEach(btn => {
                            btn.addEventListener('click', () => {
                                compDuration = btn.dataset.duration;
                                durationGrid.querySelectorAll('.duration-btn').forEach(b => b.classList.remove('active'));
                                btn.classList.add('active');
                            });
                        });

                        const restGrid = document.getElementById('composerRestGrid');
                        restGrid.innerHTML = DURATIONS.map(d => `
                            <button class="duration-btn" data-rest="${d.id}">
                                <div class="duration-symbol">${d.restLabel}</div>
                                <div class="duration-label">${t.rests[d.id]}</div>
                            </button>
                        `).join('');

                        restGrid.querySelectorAll('.duration-btn').forEach(btn => {
                            btn.addEventListener('click', () => {
                                playFrequency('A', 4, 0.05);
                                const d = DURATIONS.find(dur => dur.id === btn.dataset.rest);
                                composerNotes.push({ note: 'PAUSE', octave: 4, duration: d.val, type: d.id, label: d.label, isPause: true });
                                updateComposerStaff();
                            });
                        });
                    }
                });
            });

            document.querySelectorAll('.instrument-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    instrMode = btn.dataset.instr;
                    document.querySelectorAll('.instrument-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    updateUI();
                });
            });

            document.getElementById('testModeBtn').addEventListener('click', () => {
                isTestMode = !isTestMode;
                if (isTestMode) generateNewTestNote();
                updateUI();
            });

            document.getElementById('hintBtn').addEventListener('click', () => {
                showHint = !showHint;
                updateUI();
            });

            document.getElementById('showLabelsBtn').addEventListener('click', () => {
                showKeyLabels = !showKeyLabels;
                updateUI();
            });

            document.getElementById('pianoScroll').addEventListener('input', (e) => {
                const container = document.getElementById('pianoKeys');
                const maxScroll = container.scrollWidth - container.parentElement.clientWidth;
                container.parentElement.scrollLeft = (e.target.value / 100) * maxScroll;
            });

            document.getElementById('composerPianoScroll').addEventListener('input', (e) => {
                const container = document.getElementById('composerPianoKeys');
                const maxScroll = container.scrollWidth - container.parentElement.clientWidth;
                container.parentElement.scrollLeft = (e.target.value / 100) * maxScroll;
            });

            document.getElementById('composerScroll').addEventListener('input', (e) => {
                const container = document.getElementById('composerStaffScrollContainer');
                const maxScroll = container.scrollWidth - container.clientWidth;
                if (maxScroll > 0) {
                    container.scrollLeft = (e.target.value / 100) * maxScroll;
                }
            });

            document.querySelectorAll('.time-sig-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    rhythmSig = btn.dataset.sig;
                    document.querySelectorAll('.time-sig-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    generateNewRhythm();
                });
            });

            document.getElementById('showRhythmTargetBtn').addEventListener('click', () => {
                showRhythmTarget = !showRhythmTarget;
                updateRhythmUI();
            });

            const t = TRANSLATIONS[lang];
            const durationGrid = document.getElementById('durationGrid');
            durationGrid.innerHTML = DURATIONS.map(d => `
                <button class="duration-btn" data-duration="${d.id}">
                    <div class="duration-symbol">${d.label}</div>
                    <div class="duration-label">${t.durations[d.id]}</div>
                </button>
            `).join('');

            durationGrid.querySelectorAll('.duration-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    playFrequency('A', 4, 0.1);
                    const d = DURATIONS.find(dur => dur.id === btn.dataset.duration);
                    userRhythm.push(d);
                    updateRhythmUI();
                });
            });

            const rhythmActions = document.getElementById('rhythmActions');
            rhythmActions.innerHTML = `
                <button class="action-btn ${isListening ? 'danger' : 'dark'}" id="rhythmListenBtn">
                    ${isListening ? 
                        '<svg width="16" height="16" viewBox="0 0 24 24" fill="white"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>' :
                        '<svg width="16" height="16" viewBox="0 0 24 24" fill="white"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>'
                    }
                    ${t.listenRhythm}
                </button>
                <button class="action-btn secondary" onclick="generateNewRhythm();">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 4v6h6"></path>
                        <path d="M23 20v-6h-6"></path>
                        <path d="M20.49 9A9 9 0 005.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 013.51 15"></path>
                    </svg>
                    ${t.newRhythm}
                </button>
                <button class="action-btn primary" onclick="checkRhythm();">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    ${t.check}
                </button>
                <button class="action-btn danger" onclick="userRhythm = []; updateRhythmUI();">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                    </svg>
                    ${t.deleteAll}
                </button>
            `;

            document.getElementById('rhythmListenBtn').addEventListener('click', () => playSequence(targetRhythm));

            updateUI();
        });

        const style = document.createElement('style');
        style.textContent = '@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } } @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }';
        document.head.appendChild(style);
    </script>
</body>
</html>

